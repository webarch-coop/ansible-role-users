# {{ ansible_managed }} 

{%- for vhost,vhost_config in user.value.users_apache_virtual_hosts.items() %}

# {{ vhost_config.users_apache_server_name }}
{%- if user.value.users_apache_vhost_docroot is defined %}
# {{ user.value.users_apache_vhost_docroot }}
{%- else %}
# {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}
{%- endif %}
<VirtualHost *:80>
  ServerName {{ vhost_config.users_apache_server_name }}
  {%- if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
  {%- endif %}
  <If "%{HTTP_HOST} == '{{ vhost_config.users_apache_server_name }}'">
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ vhost_config.users_apache_server_name }}$0
  </If>
  {%- if vhost_config.users_apache_server_aliases is defined %}
  {%- for alias in vhost_config.users_apache_server_aliases %}
  <ElseIf "%{HTTP_HOST} == '{{ alias }}'">
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ alias }}$0
  </ElseIf>
  {%- endfor %}
  {%- endif %}
  <Else>
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ vhost_config.users_apache_server_name }}$0
  </Else>
</VirtualHost>
# {{ vhost_config.users_apache_server_name }}
{%- if user.value.users_apache_vhost_docroot is defined %}
# {{ user.value.users_apache_vhost_docroot }}
{%- else %}
# {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}
{%- endif %}
<VirtualHost *:443>
  ServerName {{ vhost_config.users_apache_server_name }}
  {%- if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
  {%- endif %}
  {%- if apache_mods_enabled is defined and "suexec" in apache_mods_enabled %}
  <IfModule suexec_module>
    SuexecUserGroup {{ user.key }} {{ user.key }}
  </IfModule>
  {%- endif %}
  {%- if apache_mods_enabled is defined and "mpm_itk" in apache_mods_enabled %}
  <IfModule mpm_itk_module>
    AssignUserID {{ user.key }}
    MaxClientsVHost {{ apache_mpm_itk_max_clients_vhost | default('50') }}
  </IfModule>
  {%- endif %}
  {%- if users_cert is defined %}
  SSLEngine on
    {%- if users_cert == "user" %}
  SSLCertificateFile            {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.cert.pem
  SSLCertificateKeyFile         {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.key.pem
  SSLCertificateChainFile       {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.ca.pem
    {%- endif %}
    {%- if users_cert == "vhost" %}
  SSLCertificateFile            {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.cert.pem
  SSLCertificateKeyFile         {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.key.pem
  SSLCertificateChainFile       {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.ca.pem
    {%- endif %}
  {%- endif %}
  {%- if user.value.users_email is defined and user.value.users_email != "" %}
  ServerAdmin "{{ user.value.users_email }}"
  {%- endif %}
  {%- if vhost_config.users_apache_sts is defined %}
  <IfModule headers_module>
    Header always set Strict-Transport-Security "{% for rule in vhost_config.users_apache_sts %}{{ rule }};{% endfor %}"
  </IfModule>
  {%- endif %}
  <Location "/.well-known/acme-challenge">
    AuthType None
    Require all granted
  </Location>
  {%- if vhost_config.users_apache_robots is defined and vhost_config.users_apache_robots == "deny" %}
    {%- if vhost_config.users_cms is defined and vhost_config.users_cms == "nextcloud" %}
  IncludeOptional /etc/apache2/conf-available/robots-deny-nextcloud.conf
    {%- else %}
  IncludeOptional /etc/apache2/conf-available/robots-deny.conf
    {%- endif %}
  {%- endif %}
  {%- if vhost_config.users_apache_remoteip is defined %}
    {%- if vhost_config.users_apache_remoteip == "cloudflare" %}
  IncludeOptional /etc/apache2/conf-available/cloudflare.conf
    {%- endif %}
  {%- endif %}
  {%- if apache_conf_enabled is defined %}
    {%- if "webarch" in apache_conf_enabled %}
  <Location "/wsh">
    AuthType None
    Require all granted
  </Location>
    {%- elif "mc3" in apache_conf_enabled %}
  <Location "/mc3">
    AuthType None
    Require all granted
  </Location>
    {%- endif %}
  {%- endif %}
  {%- if vhost_config.users_apache_locations is defined -%}
    {%- for loc in vhost_config.users_apache_locations %}
  <Location "{% if loc.location is defined %}{{ loc.location }}{% else %}/{% endif %}" > 
      {%- if loc.authtype is defined and loc.authtype == "None" %}
    # No AuthUserFile for this Location as AuthType is None
      {%- elif loc.authtype is not defined and loc.redirect is defined %}
    # Redirect Location so no AuthUserFile
      {%- elif loc.authtype is not defined and loc.proxypass is defined %}
    # ProxyPass Location so no AuthUserFile
      {%- elif loc.authtype is not defined and loc.proxypassreverse is defined %}
    # ProxyPassReverse Location so no AuthUserFile
      {%- else %}
    AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
      {%- endif %}
      {%- if loc.redirect is not defined and loc.proxypass is not defined and loc.proxypassreverse is not defined %}
    AuthName "{% if loc.authname is defined %}{{ loc.authname }}{% else %}Authorised Users{% endif %}"
    AuthType {% if loc.authtype is defined %}{{ loc.authtype }}{% else %}Basic{% endif %}
        {%- if loc.require is defined %}{% for req in loc.require %}
    Require {{ req }}
          {%- endfor %}{% else %}     
    Require valid-user
        {%- endif %}
      {%- else %}
        {%- if loc.redirect is defined %}
    Redirect "{{ loc.redirect }}"
        {% elif loc.proxypass is defined or loc.proxypassreverse is defined %} 
          {%- if loc.proxypass is defined %}
    ProxyPass "{{ loc.proxypass }}"
          {%- endif %}
          {%- if loc.proxypassreverse is defined %}
    ProxyPassReverse "{{ loc.proxypassreverse }}"
          {%- endif %}
        {%- endif %}
      {%- endif %}
  </Location>
    {%- endfor %}
  {%- endif %}
  {%- if vhost_config.users_apache_include_optional is defined -%}
    {%- for inc in vhost_config.users_apache_include_optional %}
  IncludeOptional {{ inc }}
    {%- endfor %}
  {%- endif %}
  {%- if vhost_config.users_apache_alias is defined %}
    {%- for alias in vhost_config.users_apache_alias %}
      {%- if alias.url is defined and alias.path is defined %}
  Alias "{{ alias.url }}" "{{ alias.path }}"
      {%- elif alias.regex_url is defined and alias.regex_path is defined %}
  AliasMatch "{{ alias.regex_url }}" "{{ alias.regex_path }}"
      {%- endif %}
    {%- endfor %}
  {%- endif %}
  {%- if user.value.users_apache_vhost_docroot is defined %}
  DocumentRoot "{{ user.value.users_apache_vhost_docroot }}" 
  <Directory "{{ user.value.users_apache_vhost_docroot }}">
  {%- else %}
  DocumentRoot "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}"
  <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}">
  {%- endif %}
  {%- if vhost_config.users_apache_options is defined %}
    Options{% for option in vhost_config.users_apache_options %} {{ option }}{% endfor %}
  {%- elif users_apache_options is defined %}
    Options {% for option in users_apache_options %} {{ option }}{% endfor %}
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC -ExecCGI
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "cgi" %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC +ExecCGI
  {%- else %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC -ExecCGI
  {%- endif %}
  {%- if vhost_config.users_apache_index is defined %}
    DirectoryIndex{% for file in vhost_config.users_apache_index %} {{ file }}{% endfor %} 
  {%- elif users_apache_index is defined %}
    DirectoryIndex{% for file in users_apache_index %} {{ file }}{% endfor %}
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
    DirectoryIndex index.php index.html index.htm index.shtml
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "cgi" %}
    DirectoryIndex index.cgi index.pl index.html index.htm index.shtml
  {%- else %}
    DirectoryIndex index.html index.htm index.shtml
  {%- endif %}
  {%- if vhost_config.users_apache_override is defined %}
    AllowOverride{% for option in vhost_config.users_apache_override %} {{ option }}{% endfor %}
  {%- elif users_apache_override is defined %}
    AllowOverride{% for option in users_apache_override %} {{ option }}{% endfor %}
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
    AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "cgi" %}
    AllowOverride AuthConfig FileInfo Indexes Limit Options=ExecCGI,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
  {%- else %}
    AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
  {%- endif %}
  {%- if vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
    {#- https://wiki.apache.org/httpd/PHP-FPM#Proxy_via_handler #}
    <IfModule proxy_fcgi_module>
      <IfModule setenvif_module>
        SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
      </IfModule>
      <FilesMatch "\.php$">
        <If "-f %{REQUEST_FILENAME}">
    {%- if user.value.users_groups is defined and "phpfpm" in user.value.users_groups %}
      {%- if "chroot" in user.value.users_groups %}
          SetHandler "proxy:unix:{{ chroot_users_dir | default('/users') }}/{{ user.key }}{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/php-fpm.sock|fcgi://localhost"
      {%- else %}
          SetHandler "proxy:unix:{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/php-fpm.sock|fcgi://localhost"
      {%- endif %}
    {%- elif users_phpfpm_version is defined %}
          SetHandler "proxy:unix:/run/php/php{{ users_phpfpm_version }}-fpm.sock|fcgi://localhost"
    {%- else -%}
          # Something went wrong the users_phpfpm_version variable needs to be 
          # set to the PHP version in order for SetHandler path to the socket 
          # to be set for the www-data user
    {%- endif %}
        </If>
      </FilesMatch>
    </IfModule>
  {%- elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "cgi" %}
    <IfModule fcgid_module>
      <IfModule mime_module>
        <FilesMatch "[^.]+\.cgi$">
          SetHandler fcgid-script
        </FilesMatch>
        <FilesMatch "[^.]+\.pl$">
          SetHandler fcgid-script
        </FilesMatch>
      </IfModule>
    </IfModule>
  {%- endif %}
    Require all granted
  {%- if vhost_config.users_apache_expires is defined and vhost_config.users_apache_expires == "medium" %}
    IncludeOptional "/etc/apache2/conf-available/expires-medium.conf"
  {%- elif vhost_config.users_apache_expires is defined and vhost_config.users_apache_expires == "strict" %}
    IncludeOptional "/etc/apache2/conf-available/expires-strict.conf"
  {%- endif %}
  </Directory>
  {%- if vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" and vhost_config.users_apache_nophp_dirs is defined %}
    {%- for dir in vhost_config.users_apache_nophp_dirs %}
  # No PHP allowed in this directory
      {%- if user.value.users_apache_vhost_docroot is defined %}
  <Directory "{{ user.value.users_apache_vhost_docroot }}/{{ dir }}">
      {%- else %}
  <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
      {%- endif %}
    <FilesMatch "\.php$">
      <If "-f %{REQUEST_FILENAME}">
        Require all denied
      </If>
    </FilesMatch>
  </Directory>
    {%- endfor %}
  {%- endif %}
  CustomLog /var/log/apache2/{{ user.key }}_access.log bandwidth
  LogLevel error
  ErrorLog  {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs/apache.error.log
  CustomLog {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs/apache.access.log combined
</VirtualHost>
{%- endfor %}

# vim: set ft=apache:
