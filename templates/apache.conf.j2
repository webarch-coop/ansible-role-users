# {{ ansible_managed }}

{% if users_cert is defined %}
{%     if users_cert == "user" %}
# One cert per user using mod_md for {{ users_apache_mdomains | join(' ') }}
<IfModule md_module>
  <IfFile /etc/apache2/md/domains/{{ user.key }}.{{ inventory_hostname }}/pubcert.pem>
    MDomain {{ users_apache_mdomains | join(' ') }}
  </IfFile>
  <IfFile !/etc/apache2/md/domains/{{ user.key }}.{{ inventory_hostname }}/pubcert.pem>
    <IfFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.fullchain.pem>
      <MDomain {{ users_apache_mdomains | join(' ') }}>
        MDCertificateFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.fullchain.pem
        MDCertificateKeyFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.key.pem
      </MDomain>
    </IfFile>
    <IfFile !{{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.fullchain.pem>
      MDomain {{ users_apache_mdomains | join(' ') }}
    </IfFile>
  </IfFile>
</IfModule>
{%     endif %}
{% endif %}

{% for vhost,vhost_config in user.value.users_apache_virtual_hosts.items() %}
# {{ vhost_config.users_apache_server_name }} port 80
<VirtualHost *:80>
  ServerName {{ vhost_config.users_apache_server_name }}
{%     if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias {{ vhost_config.users_apache_server_aliases | join(' ') }}
{%     endif %}
  <If "%{HTTP_HOST} == '{{ vhost_config.users_apache_server_name }}'">
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ vhost_config.users_apache_server_name }}$0
  </If>
{%     if vhost_config.users_apache_server_aliases is defined %}
{%         for alias in vhost_config.users_apache_server_aliases %}
  <ElseIf "%{HTTP_HOST} == '{{ alias }}'">
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ alias }}$0
  </ElseIf>
{%         endfor %}
{%     endif %}
  <Else>
    RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ vhost_config.users_apache_server_name }}$0
  </Else>
</VirtualHost>

# {{ vhost_config.users_apache_server_name }} port 443
# <IfDefine apache_chroot_dir>
#   Define users_apache_virtualhost_documentroot {{ users_apache_chroot_users_basedir ~ '/' ~ user.key ~ '/' ~ users_sites_dir ~ '/' ~ vhost }}
# </IfDefine>
# <IfDefine !apache_chroot_dir>
#   Define users_apache_virtualhost_documentroot {{ user.value.users_home | default(users_basedir ~ '/' ~ user.key) ~ '/' ~ users_sites_dir ~ '/' ~ vhost }}
# </IfDefine>

{%     if vhost_config.users_apache_vhost_docroot is not defined or vhost_config.users_apache_vhost_docroot | bool %}
# If Apache is chrooted, the DocumentRoot is {{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}
# If Apache is not chrooted, the DocumentRoot is {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}
{%         if users_apache_chroot is defined and users_apache_chroot | bool and users_apache_chroot_state is defined and users_apache_chroot_state == "active" %}
# When this file was generated Apache was set to be chrooted to {{ users_apache_chroot_dir }}
{%         else %}
# When this file was generated Apache was not set to be chrooted
{%         endif %}
{%     endif %}


{%     if users_cert is defined %}
{%         if users_cert == "vhost" %}
# One cert per vhost using mod_md for {{ vhost_config.users_apache_server_name }}
<IfModule md_module>
  <IfFile /etc/apache2/md/domains/{{ vhost_config.users_apache_server_name }}/pubcert.pem>
    MDomain {{ vhost_config.users_apache_server_name }}
  </IfFile>
  <IfFile !/etc/apache2/md/domains/{{ vhost_config.users_apache_server_name }}/pubcert.pem>
    <IfFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.fullchain.pem>
      <MDomain {{ vhost_config.users_apache_server_name }}>
        MDCertificateFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.fullchain.pem
        MDCertificateKeyFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.key.pem
      </MDomain>
    </IfFile>
    <IfFile !{{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.fullchain.pem>
      MDomain {{ vhost_config.users_apache_server_name }}
    </IfFile>
  </IfFile>
</IfModule>
{%         endif %}
{%     endif %}

<VirtualHost *:443>
  ServerName {{ vhost_config.users_apache_server_name }}
{%     if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias {{ vhost_config.users_apache_server_aliases | join(' ') }}
{%     endif %}
{%     if users_apache_chroot_suexec and "suexec" in users_apache_modules_loaded %}
  <IfModule suexec_module>
    SuexecUserGroup {{ user.key }} {{ user.value.users_group | default(user.key) }}
  </IfModule>
{%     endif %}
{%     if "mpm_itk" in users_apache_modules_loaded %}
  <IfModule mpm_itk_module>
    AssignUserID {{ user.key }}
    MaxClientsVHost {{ apache_mpm_itk_max_clients_vhost | default('50') }}
  </IfModule>
{%     endif %}
{%     if users_cert is defined %}
  <IfModule ssl_module>
    SSLEngine on
{%         if users_cert == "user" %}
    # Legacy certs, one per user
    <IfModule !md_module>
      <IfFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.cert.pem>
        SSLCertificateFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.cert.pem
      </IfFile>
      <IfFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.key.pem>
        SSLCertificateKeyFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.key.pem
      </IfFile>
      <IfFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.ca.pem>
        SSLCertificateChainFile {{ users_cert_dir }}/{{ user.key }}.{{ inventory_hostname }}.ca.pem
      </IfFile>
    </IfModule>
{%         endif %}
{%         if users_cert == "vhost" %}
    # Legacy certs, one per vhost
    <IfModule !md_module>
      <IfFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.cert.pem>
        SSLCertificateFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.cert.pem
      </IfFile>
      <IfFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.key.pem>
        SSLCertificateKeyFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.key.pem
      </IfFile>
      <IfFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.ca.pem>
        SSLCertificateChainFile {{ users_cert_dir }}/{{ vhost_config.users_apache_server_name }}.ca.pem
      </IfFile>
    </IfModule>
{%         endif %}
  </IfModule>
{%     endif %}
{%     if user.value.users_email is defined and user.value.users_email | length > 0 %}
  ServerAdmin "{{ user.value.users_email }}"
{%     endif %}
{%     if users_apache_env is defined or vhost_config.users_apache_env is defined %}
  <IfModule env_module>
{%         if users_apache_env is defined %}
{%             for setenv in users_apache_env %}
{%                 if ( setenv.set is not defined ) or ( setenv.set is defined and setenv.set | bool ) %}
    SetEnv {{ setenv.env }} {{ setenv.value }}
{%                 else  %}
    UnsetEnv {{ setenv.env }}
{%                 endif %}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_env is defined %}
{%             for setenv in vhost_config.users_apache_env %}
{%                 if ( setenv.set is not defined ) or ( setenv.set is defined and setenv.set | bool ) %}
    SetEnv {{ setenv.env }} {{ setenv.value }}
{%                 else %}
    UnsetEnv {{ setenv.env }}
{%                 endif %}
{%             endfor %}
{%         endif %}
  </IfModule>
{%     endif %}
{%     if users_apache_set_env_if is defined or vhost_config.users_apache_set_env_if is defined %}
  <IfModule setenvif_module>
{%         if users_apache_set_env_if is defined %}
{%             for setenv in users_apache_set_env_if %}
{%                 if setenv.case is not defined or setenv.case is defined and setenv.case | bool %}
    SetEnvIf {{ setenv.attribute }} "{{ setenv.regex }}" {{ setenv.env }}
{%                 else %}
    SetEnvIfNoCase {{ setenv.attribute }} "{{ setenv.regex }}" {{ setenv.env }}
{%                 endif %}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_set_env_if is defined %}
{%             for setenv in vhost_config.users_apache_set_env_if %}
{%                 if setenv.case is not defined or setenv.case is defined and setenv.case | bool %}
    SetEnvIf {{ setenv.attribute }} "{{ setenv.regex }}" {{ setenv.env }}
{%                 else %}
    SetEnvIfNoCase {{ setenv.attribute }} "{{ setenv.regex }}" {{ setenv.env }}
{%                 endif %}
{%             endfor %}
{%         endif %}
  </IfModule>
{%     endif %}
  <IfModule headers_module>
{%     if vhost_config.users_apache_headers is defined %}
{%         for header in vhost_config.users_apache_headers %}
{%             if header.type == "request" %}
    RequestHeader {{ header.action }} {{ header.arg }}
{%             elif header.type == "response" %}
{%                 if header.con is defined %}
    Header {{ header.con }} {{ header.action }} {{ header.expr }}
{%                 else %}
    Header {{ header.action }} {{ header.expr }}
{%                 endif %}
{%             endif %}
{%         endfor %}
{%     endif %}
{%     if vhost_config.users_apache_sts is defined %}
    Header setifempty Strict-Transport-Security "{{ vhost_config.users_apache_sts | join(";") }}"
{%     else %}
    Header setifempty Strict-Transport-Security "max-age=31536000"
{%     endif %}
  </IfModule>
{%     if vhost_config.users_apache_allow_encoded_slashes is defined %}
  AllowEncodedSlashes {{ vhost_config.users_apache_allow_encoded_slashes }}
{%     endif %}
{%     if vhost_config.users_apache_locations is defined %}
{%         for loc in vhost_config.users_apache_locations %}
{%             if loc.match is defined %}
  <LocationMatch "{{ loc.match }}">
{%             elif loc.location is defined %}
  <Location "{{ loc.location }}">
{%             endif %}
{%             if loc.authtype is defined and loc.authtype == "None" %}
    # No AuthUserFile for this Location as AuthType is None
{%             elif loc.authtype is not defined and loc.alias is defined %}
    # Alias Location so no AuthUserFile
{%             elif loc.authtype is not defined and loc.proxy_pass is defined %}
    # ProxyPass Location so no AuthUserFile
{%             elif loc.authtype is not defined and loc.redirect is defined %}
    # Redirect Location so no AuthUserFile
{%             else %}
    <IfDefine users_apache_chroot>
      AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
    </IfDefine>
    <IfDefine !users_apache_chroot>
      AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
    </IfDefine>


{%                 if users_apache_chroot is defined and users_apache_chroot %}
    # AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 else %}
    # AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 endif %}


{%             endif %}
{%             if loc.alias is not defined and loc.redirect is not defined and loc.proxy_pass is not defined and loc.proxy_pass_reverse is not defined %}
{%                 if loc.authname is defined %}
    AuthName "{{ loc.authname }}"
{%                 else %}
    AuthName "Authorised Users"
{%                 endif %}
{%                 if loc.authtype is defined %}
    AuthType "{{ loc.authtype }}"
{%                 else %}
    AuthType "Basic"
{%                 endif %}
{%                 if loc.require is defined %}
{%                     for req in loc.require %}
    Require {{ req }}
{%                     endfor %}
{%                 else %}
    Require valid-user
{%                 endif %}
{%             else %}
{%                 if loc.alias is defined %}
    Alias "{{ loc.alias }}"
{%                 elif loc.proxy_pass is defined %}
    <IfModule proxy_module>
{%                     if loc.preserve_host is defined %}
{%                         if loc.preserve_host | bool %}
      ProxyPreserveHost on
{%                         else %}
      ProxyPreserveHost off
{%                         endif %}
{%                     endif %}
      ProxyPass "{{ loc.proxy_pass | ansible.builtin.regex_replace('[ ]','" "') }}"
{%                     if loc.reverse is defined and loc.reverse | bool %}
      ProxyPassReverse "{{ loc.proxy_pass | ansible.builtin.regex_replace('[ ].*$') }}"
{%                     endif %}
    </IfModule>
{%                 elif loc.redirect is defined %}
    Redirect "{{ loc.redirect }}"
{%                 endif %}
{%             endif %}
{%             if loc.match is defined %}
  </LocationMatch>
{%             elif loc.location is defined %}
  </Location>
{%             endif %}
{%         endfor %}
{%     endif %}
  <Location "/.well-known/acme-challenge">
    AuthType "None"
    Require all granted
  </Location>
{%     if vhost_config.users_apache_robots is defined and vhost_config.users_apache_robots == "deny" %}
{%         if vhost_config.users_cms is defined and vhost_config.users_cms == "nextcloud" %}
  IncludeOptional "/etc/apache2/conf-available/robots-deny-nextcloud.conf"
{%         else %}
  IncludeOptional "/etc/apache2/conf-available/robots-deny.conf"
{%         endif %}
{%     endif %}
{%     if vhost_config.users_apache_remoteip is defined %}
{%         if vhost_config.users_apache_remoteip == "cloudflare" %}
  IncludeOptional "/etc/apache2/conf-available/cloudflare.conf"
{%         endif %}
{%     endif %}
{%     if apache_conf_enabled is defined %}
{%         if "webarch" in apache_conf_enabled %}
  <Location "/wsh">
    AuthType "None"
    Require all granted
  </Location>
{%         elif "mc3" in apache_conf_enabled %}
  <Location "/mc3">
    AuthType "None"
    Require all granted
  </Location>
{%         endif %}
{%     endif %}
{%     if vhost_config.users_apache_include_optional is defined %}
{%         for inc in vhost_config.users_apache_include_optional %}
  IncludeOptional "{{ inc }}"
{%         endfor %}
{%     endif %}
{%     if vhost_config.users_apache_alias is defined or vhost_config.users_apache_redirects is defined %}
  <IfModule alias_module>
{%         if vhost_config.users_apache_redirects is defined %}
{%             for redirect in vhost_config.users_apache_redirects %}
{%                 if redirect.regex_path is defined and redirect.url is defined %}
{%                     if redirect.status is defined %}
    RedirectMatch {{ redirect.status }} "{{ redirect.regex_path }}" "{{ redirect.url }}"
{%                     else %}
    RedirectMatch "{{ redirect.regex_path }}" "{{ redirect.url }}"
{%                     endif %}
{%                 elif redirect.regex_path is defined and redirect.status is defined and redirect.status is regex('^410|gone$') %}
    RedirectMatch {{ redirect.status }} "{{ redirect.regex_path }}"
{%                 elif redirect.path is defined and redirect.url is defined %}
{%                     if redirect.status is defined %}
    Redirect {{ redirect.status }} "{{ redirect.path }}" "{{ redirect.url }}"
{%                     else %}
    Redirect "{{ redirect.path }}" "{{ redirect.url }}"
{%                     endif %}
{%                 elif redirect.path is defined and redirect.status is defined and redirect.status is regex('^410|gone$') %}
    Redirect {{ redirect.status }} "{{ redirect.path }}"
{%                 endif %}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_alias is defined %}
{%             for alias in vhost_config.users_apache_alias %}
{%                 if alias.script is defined and alias.path is defined %}
    ScriptAlias "{{ alias.script }}" "{{ alias.path }}"
{%                 elif alias.regex_script is defined and alias.path is defined %}
    ScriptAliasMatch "{{ alias.script_regex }}" "{{ alias.path }}"
{%                 elif alias.url is defined and alias.path is defined %}
    Alias "{{ alias.url }}" "{{ alias.path }}"
{%                 elif alias.url_regex is defined and alias.path is defined %}
    AliasMatch "{{ alias.url_regex }}" "{{ alias.path }}"
{%                 endif %}
{%             endfor %}
{%         endif %}
  </IfModule>
{%     endif %}
{%     if vhost_config.users_apache_rewrite is defined %}
  <IfModule rewrite_module>
    RewriteEngine on
{%         for rewrite in vhost_config.users_apache_rewrite %}
{%             if rewrite.cond is defined %}
    RewriteCond {{ rewrite.cond }}
{%             endif %}
{%             if rewrite.rule is defined %}
    RewriteRule {{ rewrite.rule }}
{%             endif %}
{%         endfor %}
  </IfModule>
{%     endif %}
{%     if "proxy_fcgi" in users_apache_modules_loaded and vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^php') %}
  <IfModule proxy_fcgi_module>
{%         if user.value.users_groups is defined and "phpfpm" in user.value.users_groups %}
{%             if "chroot" in user.value.users_groups %}
    <IfDefine users_apache_chroot>
      <Proxy "unix:{{ users_apache_chroot_users_basedir }}/{{ user.key }}/php-fpm.sock|fcgi://{{ user.key }}">
{%                 if vhost_config.users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%                 elif user.value.users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%                 elif users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%                 endif %}
      </Proxy>
    </IfDefine>
    <IfDefine !users_apache_chroot>
      <Proxy "unix:{{ users_chroot_users_dir }}/{{ user.key }}{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/php-fpm.sock|fcgi://{{ user.key }}">
{%                 if vhost_config.users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%                 elif user.value.users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%                 elif users_apache_php_proxy_timeout is defined %}
        ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%                 endif %}
      </Proxy>
    </IfDefine>


{%                 if users_apache_chroot is defined and users_apache_chroot | bool %}
    # <Proxy "unix:{{ users_apache_chroot_users_basedir }}/{{ user.key }}/php-fpm.sock|fcgi://{{ user.key }}">
{%                     if vhost_config.users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%                     elif user.value.users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%                     elif users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%                     endif %}
    # </Proxy>
{%                 else %}
    # <Proxy "unix:{{ users_chroot_users_dir }}/{{ user.key }}{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/php-fpm.sock|fcgi://{{ user.key }}">
{%                     if vhost_config.users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%                     elif user.value.users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%                     elif users_apache_php_proxy_timeout is defined %}
    #   ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%                     endif %}
    # </Proxy>
{%                 endif %}


{%             else %}
{%                 if vhost_config.users_apache_php_socket_path is defined %}
    <Proxy "unix:{{ vhost_config.users_apache_php_socket_path }}|fcgi://{{ user.key }}">
{%                 else %}
    <Proxy "unix:{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/php-fpm.sock|fcgi://{{ user.key }}">
{%                 endif %}
{%                 if vhost_config.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%                 elif user.value.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%                 elif users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%                 endif %}
    </Proxy>
{%             endif %}
{%         elif users_apache_php_socket_path is defined %}
    <Proxy "unix:{{ users_apache_php_socket_path }}|fcgi://localhost">
{%             if vhost_config.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%             elif user.value.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%             elif users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%             endif %}
    </Proxy>
{%         elif users_phpfpm_system_version is defined %}
    <Proxy "unix:/run/php/php{{ users_phpfpm_system_version }}-fpm.sock|fcgi://localhost">
{%             if vhost_config.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ vhost_config.users_apache_php_proxy_timeout }}
{%             elif user.value.users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ user.value.users_apache_php_proxy_timeout }}
{%             elif users_apache_php_proxy_timeout is defined %}
      ProxySet timeout={{ users_apache_php_proxy_timeout }}
{%             endif %}
    </Proxy>
{%         else %}
    # PHP-FPM has not been enabled -- something went wrong perhaps the {{ user.key }}
    # user is not in the phpfpm group or the users_phpfpm_system_version variable
    # needs to be set to the PHP version in order for SetHandler path to the socket
    # to be set for the www-data user
{%         endif %}
  </IfModule>
{%     endif %}
{%     if vhost_config.users_apache_directories is defined %}
{%         if vhost_config.users_apache_directories == [] %}
  # No Directories are defined
{%         else %}
{%             for dir,dir_config in vhost_config.users_apache_directories.items() %}
  <IfDefine apache_chroot_dir>
{%                 if dir is not regex('^[\/].*$') %}
    Define apache_dir "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ dir }}"
{%                 elif dir is regex('^[\/].*$') %}
    # Note that the following path is not automatically updated when Apache is chrooted
    Define apache_dir "{{ dir }}"
{%                 endif %}
  </IfDefine>
  <IfDefine !apache_chroot_dir>
{%                 if dir is not regex('^[\/].*$') %}
    Define apache_dir "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ dir }}"
{%                 elif dir is regex('^[\/].*$') %}
    # Note that the following path is not automatically updated when Apache is chrooted
    Define apache_dir "{{ dir }}"
{%                 endif %}
  </IfDefine>
  <IfFile "${apache_dir}">
{%                 if dir_config.users_apache_docroot is defined and dir_config.users_apache_docroot | bool %}
    DocumentRoot "${apache_dir}">
{%                 endif %}


{%                 if users_apache_chroot is defined and users_apache_chroot | bool and dir is not regex('^[\/].*$') %}
  # <IfFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ dir }}">
{%                     if vhost_config.users_apache_vhost_docroot is defined and not vhost_config.users_apache_vhost_docroot | bool %}
{%                         if dir_config.users_apache_docroot is defined and dir_config.users_apache_docroot | bool %}
  #   DocumentRoot "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ dir }}">
{%                         endif %}
{%                     endif %}
  #   <Directory "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ dir }}">
{%                 elif dir is regex('^[\/].*$') %}
  # <IfFile "{{ dir }}">
{%                     if vhost_config.users_apache_vhost_docroot is defined and not vhost_config.users_apache_vhost_docroot | bool %}
{%                         if dir_config.users_apache_docroot is defined and dir_config.users_apache_docroot | bool %}
  #   DocumentRoot "{{ dir }}"
{%                         endif %}
{%                     endif %}
  #   <Directory "{{ dir }}">
{%                 else %}
  # <IfFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ dir }}">
{%                     if vhost_config.users_apache_vhost_docroot is defined and not vhost_config.users_apache_vhost_docroot | bool %}
{%                         if dir_config.users_apache_docroot is defined and dir_config.users_apache_docroot | bool %}
  #   DocumentRoot "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ dir }}"
{%                         endif %}
{%                     endif %}
  #   <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ dir }}">
{%                 endif %}


{%                 if dir_config.users_apache_options is defined %}
      Options {{ dir_config.users_apache_options | join(' ') }}
{%                 else %}
      Options None
{%                 endif %}
{%                 if dir_config.users_apache_ssl_options is defined %}
      <IfModule ssl_module>
        SSLOptions {{ dir_config.users_apache_ssl_options | join(' ') }}
      </IfModule>
{%                 endif %}
{%                 if dir_config.users_apache_index_options is defined %}
      IndexOptions {{ dir_config.users_apache_index_options | join(' ') }}
{%                 elif users_apache_index_options is defined %}
      IndexOptions {{ users_apache_index_options | join(' ') }}
{%                 endif %}
{%                 if dir_config.users_apache_index_head_insert is defined %}
      IndexHeadInsert "{{ dir_config.users_apache_index_head_insert | regex_replace('[\"]', '\\"') }}"
{%                 elif users_apache_index_head_insert is defined %}
      IndexHeadInsert "{{ users_apache_index_head_insert | regex_replace('[\"]', '\\"') }}"
{%                 endif %}
{%                 if dir_config.users_apache_header_name is defined %}
      HeaderName {{ dir_config.users_apache_header_name }}
{%                 elif users_apache_header_name is defined %}
      HeaderName {{ users_apache_header_name is defined }}
{%                 endif %}
{%                 if dir_config.users_apache_readme_name is defined %}
      ReadmeName {{ dir_config.users_apache_readme_name }}
{%                 elif users_apache_readme_name is defined %}
      ReadmeName {{ users_apache_readme_name is defined }}
{%                 endif %}
{%                 if dir_config.users_apache_ssi_legacy is defined %}
{%                     if dir_config.users_apache_ssi_legacy | bool %}
      SSILegacyExprParser on
{%                     else %}
      SSILegacyExprParser off
{%                     endif %}
{%                 elif users_apache_ssi_legacy is defined %}
{%                     if users_apache_ssi_legacy | bool %}
      SSILegacyExprParser on
{%                     else %}
      SSILegacyExprParser off
{%                     endif %}
{%                     if users_apache_ssi_legacy | bool %}
      SSILegacyExprParser on
{%                     else %}
      SSILegacyExprParser off
{%                     endif %}
{%                 endif %}
{%                 if dir_config.users_apache_ssi_modified is defined %}
{%                     if dir_config.users_apache_ssi_modified | bool %}
      SSILastModified on
{%                     else %}
      SSILastModified off
{%                     endif %}
{%                 endif %}
{%                 if dir_config.users_apache_index is defined %}
{%                     set users_apache_template_directory_index = dir_config.users_apache_index %}
{%                 elif users_apache_index is defined %}
{%                     set users_apache_template_directory_index = users_apache_index %}
{%                 else %}
{%                     set users_apache_template_directory_index = ['index.html', 'index.htm', 'index.shtml'] %}
{%                     if dir_config.users_apache_type is defined and dir_config.users_apache_type is regex('^php') %}
{%                         if dir_config.users_phpfpm_extensions is defined %}
{%                             set users_apache_template_directory_index = dir_config.users_phpfpm_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                         elif user.value.users_phpfpm_extensions is defined %}
{%                             set users_apache_template_directory_index = user.value.users_phpfpm_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                         else %}
{%                             set users_apache_template_directory_index = ['index.php'] + users_apache_template_directory_index %}
{%                         endif %}
{%                     endif %}
{%                     if dir_config.users_apache_type is defined and dir_config.users_apache_type is regex('cgi$') %}
{%                         if dir_config.users_apache_cgi_extensions is defined %}
{%                             set users_apache_template_directory_index = dir_config.users_apache_cgi_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                         elif user.value.users_apache_cgi_extensions is defined %}
{%                             set users_apache_template_directory_index = user.value.users_apache_cgi_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                         else %}
{%                             set users_apache_template_directory_index = ['index.cgi', 'index.pl'] + users_apache_template_directory_index %}
{%                         endif %}
{%                     endif %}
{%                 endif %}
      DirectoryIndex {{ users_apache_template_directory_index | join(' ') }}
{%                 if dir_config.users_apache_override is defined %}
      AllowOverride {{ dir_config.users_apache_override | join(' ') }}
{%                 else %}
      AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
{%                 endif %}
{%                 if dir_config.users_apache_add_output_filters is defined %}
{%                     for filter in dir_config.users_apache_add_output_filters %}
      AddOutputFilter {{ filter }}
{%                     endfor %}
{%                 endif %}
{%                 if dir_config.users_apache_add_type is defined %}
{%                     for mimetype in dir_config.users_apache_add_type %}
      AddType "{{ mimetype.type }}" .{{ mimetype.ext }}
{%                     endfor %}
{%                 endif %}
{%                 if dir_config.users_apache_filesmatch is defined %}
{%                     for fm in dir_config.users_apache_filesmatch %}
      <FilesMatch "{{ fm.regex }}" >
{%                         if fm.require is defined %}
{%                             for req in fm.require %}
        Require {{ req }}
{%                             endfor %}
{%                         else %}
        Require all denied
{%                         endif %}
      </FilesMatch>
{%                     endfor %}
{%                 endif %}
{%                 if dir_config.users_apache_auth_name is defined %}
      AuthName "{{ dir_config.users_apache_auth_name }}"
{%                 endif %}
{%                 if dir_config.users_apache_auth_type is defined %}
      AuthType "{{ dir_config.users_apache_auth_type }}"
{%                     if dir_config.users_apache_auth_type == "Basic" %}
{%                         if users_apache_chroot is defined and users_apache_chroot %}
      AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost.users_apache_server_name }}"
{%                         else %}
      AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost.users_apache_server_name }}"
{%                         endif %}
{%                     endif %}
{%                 elif dir_config.users_apache_auth_type is not defined or dir_config.users_apache_auth_type == "None" %}
      AuthType "None"
{%                 else %}
      AuthType "{{ dir_config.users_apache_auth_type }}"
{%                 endif %}
{%                 if dir_config.users_apache_require is defined and dir_config.users_apache_require != [] %}
{%                     for req in dir_config.users_apache_require %}
      Require {{ req }}
{%                     endfor %}
{%                 else %}
      Require all granted
{%                 endif %}
{%                 if "proxy_fcgi" in users_apache_modules_loaded and dir_config.users_apache_type is defined and dir_config.users_apache_type is regex('^php') %}
{#    https://wiki.apache.org/httpd/PHP-FPM#Proxy_via_handler #}
      <IfModule proxy_fcgi_module>
{%                     if user.value.users_phpfpm_extensions is defined %}
        <FilesMatch "\.({{ user.value.users_phpfpm_extensions | join('|') }})$">
{%                     elif users_phpfpm_extensions is defined %}
        <FilesMatch "\.({{ users_phpfpm_extensions | join('|') }})$">
{%                     else %}
        <FilesMatch "\.php$">
{%                     endif %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
{%                     if user.value.users_groups is defined and "phpfpm" in user.value.users_groups %}
            SetHandler "proxy:fcgi://{{ user.key }}"
{%                     elif users_phpfpm_system_version is defined %}
            SetHandler "proxy:fcgi://localhost"
{%                     endif %}
          </If>
        </FilesMatch>
      </IfModule>
{%                 endif %}
{%                 if "cgid" in users_apache_modules_loaded and dir_config.users_apache_type is defined and dir_config.users_apache_type is regex('^cgi|php[+]cgi$') %}
      <IfModule cgid_module>
        <IfModule mime_module>
{%                     if user.value.users_apache_cgi_extension_match is not defined or user.value.users_apache_cgi_extension_match | bool %}
{%                         if user.value.users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ user.value.users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                         else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                         endif %}
{%                     elif user.value.users_apache_cgi_extension_match is defined and not user.value.users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler cgi-script
          </If>
{%                     elif users_apache_cgi_extension_match is not defined or users_apache_cgi_extension_match | bool %}
{%                         if users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                         else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                         endif %}
{%                     elif users_apache_cgi_extension_match is defined and not users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler cgi-script
          </If>
{%                     endif %}
        </IfModule>
      </IfModule>
{%                 elif "fcgid" in users_apache_modules_loaded and dir_config.users_apache_type is defined and dir_config.users_apache_type is regex('fcgi$') %}
      <IfModule fcgid_module>
        <IfModule mime_module>
{%                     if user.value.users_apache_cgi_extension_match is not defined or user.value.users_apache_cgi_extension_match | bool %}
{%                         if user.value.users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ user.value.users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                         else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                         endif %}
{%                     elif user.value.users_apache_cgi_extension_match is defined and not user.value.users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler fcgid-script
          </If>
{%                     elif users_apache_cgi_extension_match is not defined or users_apache_cgi_extension_match | bool %}
{%                         if users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                         else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                         endif %}
{%                     elif users_apache_cgi_extension_match is defined and not users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler fcgid-script
          </If>
{%                     endif %}
        </IfModule>
      </IfModule>
{%                 endif %}
{%                 if dir_config.users_apache_expires is defined %}
{%                     if dir_config.users_apache_expires == "active" %}
      IncludeOptional "/etc/apache2/conf-available/expires-active.conf"
{%                     elif dir_config.users_apache_expires == "medium" %}
      IncludeOptional "/etc/apache2/conf-available/expires-medium.conf"
{%                     elif dir_config.users_apache_expires == "strict" %}
      IncludeOptional "/etc/apache2/conf-available/expires-strict.conf"
{%                     elif dir_config.users_apache_expires == "forever" %}
      IncludeOptional "/etc/apache2/conf-available/expires-forever.conf"
{%                     endif %}
{%                 endif %}
    </Directory>
  </IfFile>
{%             endfor %}
{%         endif %}
{%     endif %}
{%     if vhost_config.users_apache_vhost_docroot is not defined or vhost_config.users_apache_vhost_docroot | bool %}
  <IfDefine users_apache_chroot>
    Define apache_vhost_docroot "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}"
  </IfDefine>
  <IfDefine !users_apache_chroot>
    Define apache_vhost_docroot "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}"
  </IfDefine>
  <IfFile "${apache_vhost_docroot}">
    DocumentRoot "${apache_vhost_docroot}"


{%         if users_apache_chroot is defined and users_apache_chroot %}
  # <IfFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}">
  #   DocumentRoot "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}"
  #   <Directory "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}">
{%         else %}
  # <IfFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}">
  #   DocumentRoot "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}"
  #   <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}">
{%         endif %}



{%         if vhost_config.users_apache_options is defined %}
      Options {{ vhost_config.users_apache_options | join(' ') }}
{%         elif users_apache_options is defined %}
      Options {{ users_apache_options | join(' ') }}
{%         elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('cgi$') %}
      Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC +ExecCGI
{%         else %}
      Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC -ExecCGI
{%         endif %}
{%         if vhost_config.users_apache_ssl_options is defined %}
      <IfModule ssl_module>
        SSLOptions {{ vhost_config.users_apache_ssl_options | join(' ') }}
      </IfModule>
{%         endif %}
{%         if vhost_config.users_apache_index_head_insert is defined %}
      IndexHeadInsert "{{ vhost_config.users_apache_index_head_insert | regex_replace('[\"]', '\\"') }}"
{%         elif users_apache_index_head_insert is defined %}
      IndexHeadInsert "{{ users_apache_index_head_insert | regex_replace('[\"]', '\\"') }}"
{%         endif %}
{%         if vhost_config.users_apache_index_options is defined %}
      IndexOptions {{ vhost_config.users_apache_index_options | join(' ') }}
{%         elif users_apache_index_options is defined %}
      IndexOptions {{ users_apache_index_options | join(' ') }}
{%         endif %}
{%         if vhost_config.users_apache_header_name is defined %}
      HeaderName {{ vhost_config.users_apache_header_name }}
{%         elif users_apache_header_name is defined %}
      HeaderName {{ users_apache_header_name is defined }}
{%         endif %}
{%         if vhost_config.users_apache_readme_name is defined %}
      ReadmeName {{ vhost_config.users_apache_readme_name }}
{%         elif users_apache_readme_name is defined %}
      ReadmeName {{ users_apache_readme_name is defined }}
{%         endif %}
{%         if vhost_config.users_apache_ssi_legacy is defined %}
{%             if vhost_config.users_apache_ssi_legacy %}
      SSILegacyExprParser on
{%             else %}
      SSILegacyExprParser off
{%             endif %}
{%         endif %}
{%         if vhost_config.users_apache_index is defined %}
{%             set users_apache_template_directory_index = vhost_config.users_apache_index %}
{%         elif users_apache_index is defined %}
{%             set users_apache_template_directory_index = users_apache_index %}
{%         else %}
{%             set users_apache_template_directory_index = ['index.html', 'index.htm', 'index.shtml'] %}
{%             if vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^php') %}
{%                 if vhost_config.users_phpfpm_extensions is defined %}
{%                     set users_apache_template_directory_index = vhost_config.users_phpfpm_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                 elif user.value.users_phpfpm_extensions is defined %}
{%                     set users_apache_template_directory_index = user.value.users_phpfpm_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                 else %}
{%                     set users_apache_template_directory_index = ['index.php'] + users_apache_template_directory_index %}
{%                 endif %}
{%             endif %}
{%             if vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('cgi$') %}
{%                 if vhost_config.users_apache_cgi_extensions is defined %}
{%                     set users_apache_template_directory_index = vhost_config.users_apache_cgi_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                 elif user.value.users_apache_cgi_extensions is defined %}
{%                     set users_apache_template_directory_index = user.value.users_apache_cgi_extensions | map('regex_replace', '^', 'index.') + users_apache_template_directory_index %}
{%                 else %}
{%                     set users_apache_template_directory_index = ['index.cgi', 'index.pl'] + users_apache_template_directory_index %}
{%                 endif %}
{%             endif %}
{%         endif %}
      DirectoryIndex {{ users_apache_template_directory_index | join(' ') }}
{%         if vhost_config.users_apache_override is defined %}
      AllowOverride {{ vhost_config.users_apache_override | join(' ') }}
{%         elif users_apache_override is defined %}
      AllowOverride {{ users_apache_override | join(' ') }}
{%         elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
      AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
{%         elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('cgi$') %}
      AllowOverride AuthConfig FileInfo Indexes Limit Options=ExecCGI,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
{%         else %}
      AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=All
{%         endif %}
{%         if users_apache_add_output_filters is defined %}
{%             for filter in users_apache_add_output_filters %}
      AddOutputFilter {{ filter }}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_add_output_filters is defined %}
{%             for filter in vhost_config.users_apache_add_output_filters %}
      AddOutputFilter {{ filter }}
{%             endfor %}
{%         endif %}
{%         if users_apache_add_type is defined %}
{%             for mimetype in users_apache_add_type %}
      AddType "{{ mimetype.type }}" .{{ mimetype.ext }}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_add_type is defined %}
{%             for mimetype in vhost_config.users_apache_add_type %}
      AddType "{{ mimetype.type }}" .{{ mimetype.ext }}
{%             endfor %}
{%         endif %}
{%         if vhost_config.users_apache_filesmatch is defined %}
{%             for fm in vhost_config.users_apache_filesmatch %}
      <FilesMatch "{{ fm.regex }}" >
{%                 if fm.require is defined %}
{%                     for req in fm.require %}
        Require {{ req }}
{%                     endfor %}
{%                 else %}
        Require all denied
{%                 endif %}
      </FilesMatch>
{%             endfor %}
{%         endif %}
{%         if "proxy_fcgi" in users_apache_modules_loaded and vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^php') %}
{#    https://wiki.apache.org/httpd/PHP-FPM#Proxy_via_handler #}
      <IfModule proxy_fcgi_module>
{%             if user.value.users_phpfpm_extensions is defined %}
        <FilesMatch "\.({{ user.value.users_phpfpm_extensions | join('|') }})$">
{%             elif users_phpfpm_extensions is defined %}
        <FilesMatch "\.({{ users_phpfpm_extensions | join('|') }})$">
{%             else %}
        <FilesMatch "\.php$">
{%             endif %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
{%             if user.value.users_groups is defined and "phpfpm" in user.value.users_groups %}
            SetHandler "proxy:fcgi://{{ user.key }}"
{%             elif users_phpfpm_system_version is defined %}
            SetHandler "proxy:fcgi://localhost"
{%             endif %}
          </If>
        </FilesMatch>
      </IfModule>
{%         endif %}
{%         if "cgid" in users_apache_modules_loaded and vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^cgi|php[+]cgi$') %}
      <IfModule cgid_module>
        <IfModule mime_module>
{%             if user.value.users_apache_cgi_extension_match is not defined or user.value.users_apache_cgi_extension_match | bool %}
{%                 if user.value.users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ user.value.users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                 else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                 endif %}
{%             elif user.value.users_apache_cgi_extension_match is defined and not user.value.users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler cgi-script
          </If>
{%             elif users_apache_cgi_extension_match is not defined or users_apache_cgi_extension_match | bool %}
{%                 if users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                 else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler cgi-script
            </If>
          </FilesMatch>
{%                 endif %}
{%             elif users_apache_cgi_extension_match is defined and not users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler cgi-script
          </If>
{%             endif %}
        </IfModule>
      </IfModule>
{%         elif "fcgid" in users_apache_modules_loaded and vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^fcgi|php[+]fcgi$') %}
      <IfModule fcgid_module>
        <IfModule mime_module>
{%             if user.value.users_apache_cgi_extension_match is not defined or user.value.users_apache_cgi_extension_match | bool %}
{%                 if user.value.users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ user.value.users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                 else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                 endif %}
{%             elif user.value.users_apache_cgi_extension_match is defined and not user.value.users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler fcgid-script
          </If>
{%             elif users_apache_cgi_extension_match is not defined or users_apache_cgi_extension_match | bool %}
{%                 if users_apache_cgi_extensions is defined %}
          <FilesMatch "\.({{ users_apache_cgi_extensions | join('|') }})$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                 else %}
          <FilesMatch "\.(cgi|pl)$">
            <If "-f %{REQUEST_FILENAME}">
              <IfModule setenvif_module>
                SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
              </IfModule>
              SetHandler fcgid-script
            </If>
          </FilesMatch>
{%                 endif %}
{%             elif users_apache_cgi_extension_match is defined and not users_apache_cgi_extension_match | bool %}
          <If "-f %{REQUEST_FILENAME}">
            <IfModule setenvif_module>
              SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
            </IfModule>
            SetHandler fcgid-script
          </If>
{%             endif %}
        </IfModule>
      </IfModule>
{%         endif %}
{%         if vhost_config.users_apache_auth_name is defined %}
      AuthName "{{ vhost_config.users_apache_auth_name }}"
{%         endif %}
{%         if vhost_config.users_apache_auth_type is defined %}
      AuthType "{{ vhost_config.users_apache_auth_type }}"
{%             if vhost_config.users_apache_auth_type == "Basic" %}
      <IfDefine users_apache_chroot>
        AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
      </IfDefine>
      <IfDefine !users_apache_chroot>
        AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
      </IfDefine>


{%                 if users_apache_chroot is defined and users_apache_chroot %}
      # AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 else %}
      # AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 endif %}



{%             endif %}
{%         else %}
      AuthType "None"
{%         endif %}
{%         if vhost_config.users_apache_require is defined and vhost_config.users_apache_require != [] %}
{%             for req in vhost_config.users_apache_require %}
      Require {{ req }}
{%             endfor %}
{%         else %}
      Require all granted
{%         endif %}
{%         if vhost_config.users_apache_expires is defined %}
{%             if vhost_config.users_apache_expires == "active" %}
      IncludeOptional "/etc/apache2/conf-available/expires-active.conf"
{%             elif vhost_config.users_apache_expires == "medium" %}
      IncludeOptional "/etc/apache2/conf-available/expires-medium.conf"
{%             elif vhost_config.users_apache_expires == "strict" %}
      IncludeOptional "/etc/apache2/conf-available/expires-strict.conf"
{%             elif vhost_config.users_apache_expires == "forever" %}
      IncludeOptional "/etc/apache2/conf-available/expires-forever.conf"
{%             endif %}
{%         endif %}
    </Directory>
  </IfFile>
{%     endif %}
{%     if vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^php') and vhost_config.users_apache_nophp_dirs is defined %}
{%         for users_apache_dir in vhost_config.users_apache_nophp_dirs %}
  # No PHP allowed in this directory
  <IfDefine users_apache_chroot>
    Define apache_dir_{{ users_apache_dir | ansible.builtin.regex_replace('[.]', '_') }} "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}">
  </IfDefine>
  <IfDefine !users_apache_chroot>
    Define apache_dir_{{ users_apache_dir | ansible.builtin.regex_replace('[.]', '_') }} "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}"
  </IfDefine>
  <IfFile "${apache_dir_{{ users_apache_dir | ansible.builtin.regex_replace('[.]', '_') }}">
    <Directory "${apache_dir_{{ users_apache_dir | ansible.builtin.regex_replace('[.]', '_') }}">


{%             if users_apache_chroot is defined and users_apache_chroot %}
  # No PHP allowed in this directory
  # <IfFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}">
  #   <Directory "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}">
{%             else %}
  # No PHP allowed in this directory
  # <IfFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}">
  #   <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ users_apache_dir }}">
{%             endif %}


{%             if users.value.users_phpfpm_extensions is defined %}
      RemoveHandler {{ users.value.users_phpfpm_extensions | map('regex_replace', '^', '.') | join(' ') }}
{%             elif users_phpfpm_extensions is defined %}
      RemoveHandler {{ users_phpfpm_extensions | map('regex_replace', '^', '.') | join(' ') }}
{%             else %}
      RemoveHandler .php
{%             endif %}
{%             if users.value.users_phpfpm_extensions is defined %}
      <FilesMatch "\.({{ users.value.users_phpfpm_extensions | join('|') }})$">
{%             elif users_phpfpm_extensions is defined %}
      <FilesMatch "\.({{ users_phpfpm_extensions | join('|') }})$">
{%             else %}
      <FilesMatch "\.php$">
{%             endif %}
        <If "-f %{REQUEST_FILENAME}">
          Require all denied
        </If>
      </FilesMatch>
    </Directory>
  </IfFile>
{%         endfor %}
{%     endif %}
{%     if vhost_config.users_apache_deny_dirs is defined %}
{%         for dir in vhost_config.users_apache_deny_dirs %}
  <IfDefine users_apache_chroot>
    # No access allowed for this directory
    <IfFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
      <Directory "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
        Require all denied
      </Directory>
    </IfFile>
  </IfDefine>
  <IfDefine !users_apache_chroot>
    # No access allowed for this directory
    <IfFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
      <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
        Require all denied
      </Directory>
    </IfFile>
  </IfDefine>
{%             if users_apache_chroot is defined and users_apache_chroot %}
  # No access allowed for this directory
  # <IfFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
  #   <Directory "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
  #     Require all denied
  #   </Directory>
  # </IfFile>
{%             else %}
  # No access allowed for this directory
  # <IfFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
  #   <Directory "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}/{{ dir }}">
  #     Require all denied
  #   </Directory>
  # </IfFile>
{%             endif %}
{%         endfor %}
{%     endif %}
{%     if vhost_config.users_apache_proxy_pass is defined %}
  <IfModule proxy_module>
    # In reverse proxy or gateway configuration, ProxyRequests should be set to Off
    ProxyRequests Off
    # Serve Apache error documents rather than proxy errors
    ProxyErrorOverride On
{%         for proxy in vhost_config.users_apache_proxy_pass %}
{%             if proxy.preserve_host is defined %}
{%                 if proxy.preserve_host | bool %}
    ProxyPreserveHost on
{%                 else %}
    ProxyPreserveHost off
{%                 endif %}
{%             endif %}
{%             if proxy.add_headers is defined %}
{%                 if proxy.add_headers | bool %}
    ProxyAddHeaders on
{%                 else %}
    ProxyAddHeaders off
{%                 endif %}
{%             endif %}
{%             if apache_conf_enabled is defined %}
{%                 if "webarch" in apache_conf_enabled %}
    ProxyPass "/wsh/" "!"
{%                 elif "mc3" in apache_conf_enabled %}
    ProxyPass "/mc3/" "!"
{%                 endif %}
{%             endif %}
{%             if proxy.path is defined and proxy.url is defined %}
    ProxyPass "{{ proxy.path }}" "{{ proxy.url }}"
{%             endif %}
{%             if proxy.pathmatch is defined and proxy.url is defined %}
    ProxyPassMatch "{{ proxy.pathmatch }}" "{{ proxy.url }}"
{%             endif %}
{%             if proxy.rewrite_rules is defined and proxy.rewrite_rules != [] %}
    RewriteEngine On
{%             endif %}
{%             if proxy.rewrite_conditions is defined %}
{%                 for cond in proxy.rewrite_conditions %}
    RewriteCond {{ cond }}
{%                 endfor %}
{%             endif %}
{%             if proxy.rewrite_rules is defined %}
{%                 for rule in proxy.rewrite_rules %}
    RewriteRule {{ rule }}
{%                 endfor %}
{%             endif %}
{%             if proxy.reverse is defined and proxy.reverse | bool and proxy.path is defined and proxy.url is defined %}
    ProxyPassReverse "{{ proxy.path }}" "{{ proxy.url | regex_replace('[ ].*$') }}"
{%             endif %}
{%             if proxy.htauth is defined and proxy.htauth %}
    <Proxy "{{ proxy.url }}">
{%                 if proxy.authtype is defined %}
      AuthType "{{ proxy.authtype }}"
{%                 else %}
      AuthType "Basic"
{%                 endif %}
{%                 if proxy.authname is defined %}
      AuthName "{{ proxy.authname }}"
{%                 else %}
      AuthName "Authorised Users"
{%                 endif %}
      <IfDefine users_apache_chroot>
        AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
      </IfDefine>
      <IfDefine !users_apache_chroot>
        AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
      </IfDefine>
{%                 if users_apache_chroot is defined and users_apache_chroot %}
      # AuthUserFile "{{ users_apache_chroot_users_basedir }}/{{ user.key }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 else %}
      # AuthUserFile "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.htpasswd/{{ vhost_config.users_apache_server_name }}"
{%                 endif %}
{%                 if proxy.require is defined %}
{%                     for req in proxy.require %}
      Require {{ req }}
{%                     endfor %}
{%                 else %}
      Require valid-user
{%                 endif %}
    </Proxy>
{%             endif %}
{%         endfor %}
  </IfModule>
{%     endif %}
{%     if vhost_config.users_apache_error_docs is defined %}
{%         for doc in vhost_config.users_apache_error_docs %}
  ErrorDocument {{ doc.code }} {{ doc.path }}
{%         endfor %}
{%     endif %}
{%     if user.value.users_system is not defined or not user.value.users_system | bool %}
  CustomLog /var/log/apache2/{{ user.key }}_access.log bandwidth
  LogLevel error
  <IfFile {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs>
    ErrorLog  {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs/apache.error.log
    CustomLog {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs/apache.access.log combined
{%         if vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^cgi|php[+]cgi$') %}
    # Uncomment the ScriptLog for CGI debugging
    # https://httpd.apache.org/docs/current/mod/mod_cgi.html#scriptlog
    # ScriptLog {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/logs/apache.cgi.log
{%         endif %}
  </IfFile>
{%     else %}
  ErrorLog ${APACHE_LOG_DIR}/{{ vhost_config.users_apache_server_name }}.error.log
  CustomLog ${APACHE_LOG_DIR}/{{ vhost_config.users_apache_server_name }}.access.log combined
{%         if vhost_config.users_apache_type is defined and vhost_config.users_apache_type is regex('^cgi|php[+]cgi$') %}
  # Uncomment the ScriptLog for CGI debugging
  # https://httpd.apache.org/docs/current/mod/mod_cgi.html#scriptlog
  # ScriptLog ${APACHE_LOG_DIR}/{{ vhost_config.users_apache_server_name }}.cgi.log
{%         endif %}
{%     endif %}
</VirtualHost>
{% endfor %}

# vim: syntax=apache{# vim: syntax=jinja2 #}
