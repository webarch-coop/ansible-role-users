# {{ ansible_managed }} 

{%- for vhost,vhost_config in user.value.users_apache_virtual_hosts.items() %}

# {{ vhost_config.users_apache_server_name }}
{%- if user.value.users_apache_vhost_docroot is defined %}
# {{ user.value.users_apache_vhost_docroot }}
{%- else %}
# {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}
{%- endif %}
<VirtualHost *:80>
  ServerName {{ vhost_config.users_apache_server_name }}
  {%- if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
  {%- endif %}
  RedirectMatch 301 ^(?!/\.well-known/acme-challenge/).* https://{{ vhost_config.users_apache_server_name }}$0
</VirtualHost>
# {{ vhost_config.users_apache_server_name }}
{%- if user.value.users_apache_vhost_docroot is defined %}
# {{ user.value.users_apache_vhost_docroot }}
{%- else %}
# {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/{{ users_sites_dir }}/{{ vhost }}
{%- endif %}
<VirtualHost *:443>
  ServerName {{ vhost_config.users_apache_server_name }}
  {%- if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
  {%- endif %}
  {%- if apache_mods_enabled is defined and "suexec" in apache_mods_enabled %}
  <IfModule suexec_module>
    SuexecUserGroup {{ user.key }} {{ user.key }}
  </IfModule>
  {%- endif %}
  {%- if apache_mods_enabled is defined and "mpm_itk" in apache_mods_enabled %}
  <IfModule mpm_itk_module>
    AssignUserID {{ user.key }}
    MaxClientsVHost {{ apache_mpm_itk_max_clients_vhost | default('50') }}
  </IfModule>
  {%- endif %}
  {%- if users_cert is defined %}
  SSLEngine on
    {%- if users_cert == "user" %}
  SSLCertificateFile            {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.cert.pem
  SSLCertificateKeyFile         {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.key.pem
  SSLCertificateChainFile       {{ le_dir }}/{{ user.key }}.{{ inventory_hostname }}.ca.pem
    {%- endif %}
    {%- if users_cert == "vhost" %}
  SSLCertificateFile            {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.cert.pem
  SSLCertificateKeyFile         {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.key.pem
  SSLCertificateChainFile       {{ le_dir }}/{{ vhost_config.users_apache_server_name }}.ca.pem
    {%- endif %}
  {%- endif %}
  {%- if user.value.users_email is defined and user.value.users_email != "" %}
  ServerAdmin "{{ user.value.users_email }}"
  {%- endif %}
</VirtualHost>
{%- endfor %}

# vim: set ft=apache:
