# Ansible provisioned
{% for vhost,vhost_config in item.value.users_apache_virtual_hosts.items() %}

# {{ vhost }}
<VirtualHost *:80>
  ServerName {{ vhost_config.users_apache_server_name }}
{% if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
{% endif %}

  # This shouldn't be needed due to server wide alias
  # Alias "/.well-known/acme-challenge" "{{ document_root }}/.well-known/acme-challenge"
  # <Directory "{{ document_root }}/.well-known/acme-challenge">
  #   Options None
  #   AllowOverride None
  #   ForceType text/plain
  #   Allow from All
  # </Directory>
  Redirect / https://{{ vhost_config.users_apache_server_name }}/
</VirtualHost>

<VirtualHost *:443>
{% if apache_mods_enabled is defined and "suexec" in apache_mods_enabled %}
<IfModule suexec_module>
  SuexecUserGroup {{ item.key }} {{ item.key }}
</IfModule>
{% endif %}
{% if apache_mods_enabled is defined and "mpm_itk" in apache_mods_enabled %}
<IfModule mpm_itk_module>
  AssignUserID {{ item.key }}
  MaxClientsVHost {{ apache_mpm_itk_max_clients_vhost | default('50') }}
</IfModule>
{% endif %}

  ServerName {{ vhost_config.users_apache_server_name }}
{% if vhost_config.users_apache_server_aliases is defined %}
  ServerAlias{% for alias in vhost_config.users_apache_server_aliases %} {{ alias }}{% endfor %}
{% endif %}

  SSLEngine on
  SSLCertificateFile            {{ le_dir }}/{{ item.key }}.{{ inventory_hostname }}.cert.pem
  SSLCertificateKeyFile         {{ le_dir }}/{{ item.key }}.{{ inventory_hostname }}.key.pem
  SSLCertificateChainFile       {{ le_dir }}/{{ item.key }}.{{ inventory_hostname }}.ca.pem

{% if item.value.users_email is defined and item.value.users_email != "" %}
  ServerAdmin "{{ item.value.users_email }}"
{% endif %}
  DocumentRoot "{{ item.value.users_home | default('/home/' + item.key) }}/sites/{{ vhost }}"
  <Directory "{{ item.value.users_home | default('/home/' + item.key) }}/sites/{{ vhost }}">
{% if vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "php" %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC -ExecCGI
    DirectoryIndex index.php index.html index.shtml index.htm index.xhtml wsh.shtml
    AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=Override
    # https://wiki.apache.org/httpd/PHP-FPM#Proxy_via_handler
    <IfModule proxy_fcgi_module>
      <IfModule setenvif_module>
        SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
      </IfModule>
      <FilesMatch "\.php$">
        <If "-f %{REQUEST_FILENAME}">
          # SetHandler "proxy:unix:{{ item.value.users_home | default('/home/' + item.key) }}/php-fpm.sock|fcgi://localhost/"
          SetHandler "proxy:unix:{{ chroot_users_dir | default('/chroot-users') }}/{{ item.key }}{{ item.value.users_home | default('/home/' + item.key) }}/php-fpm.sock|fcgi://localhost/"
        </If>
      </FilesMatch>
    </IfModule>
{% elif vhost_config.users_apache_type is defined and vhost_config.users_apache_type == "cgi" %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC +ExecCGI
    DirectoryIndex index.html index.php index.shtml index.xhtml index.cgi index.pl index.htm wsh.shtml
    AllowOverride AuthConfig FileInfo Indexes Limit Options=ExecCGI,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=Override
    <IfModule fcgid_module>
      <IfModule mime_module>
        <FilesMatch "[^.]+\.cgi$">
          SetHandler fcgid-script
        </FilesMatch>
        <FilesMatch "[^.]+\.pl$">
          SetHandler fcgid-script
        </FilesMatch>
      </IfModule>
    </IfModule>
{% else %}
    Options -Indexes +SymlinksIfOwnerMatch -MultiViews +IncludesNOEXEC -ExecCGI
    DirectoryIndex index.html index.shtml index.htm index.xhtml wsh.shtml
    AllowOverride AuthConfig FileInfo Indexes Limit Options=Indexes,SymLinksIfOwnerMatch,MultiViews,IncludesNOEXEC Nonfatal=Override
{% endif %}
    Require all granted
  </Directory>
  CustomLog /var/log/apache2/{{ item.key }}_access.log bandwidth
  LogLevel error
  ErrorLog  {{ item.value.users_home | default('/home/' + item.key) }}/logs/error.log
  CustomLog {{ item.value.users_home | default('/home/' + item.key) }}/logs/access.log combinedio
</VirtualHost>
{% endfor %}
