---
- name: Slay any processes running as the user
  command: "slay {{ user.key }}"
  tags:
    - users-chroot
    - users-update

- name: Crontab absent for users
  include_tasks: crontab_users_absent.yml
  tags:
    - users-update
    - users-cron
    - users-scripts

- name: Chroot users absent from /etc/fstab
  block:

    - name: Include the chroot users /etc/fstab entries absent tasks
      include_tasks: chroot_users_absent_fstab.yml
      when: ( user.value.users_state is defined and user.value.users_state == "absent" ) or ( "chroot" not in user.value.users_groups )
      tags:
        - users-chroot
        - users-update
        - users-fstab

  when: ( users_chroot_dir is defined ) and ( users_chroot_dir.stat.exists )

- name: Include Apache config tasks absent users
  include_tasks: apache_users_absent.yml
  when:
    - ( "apache2" in ansible_facts.packages )
    - ( users_apache is defined ) and ( users_apache == True )
  tags:
    - users-update
    - apache

- name: Include PHP FPM chroot users absent tasks
  include_tasks: phpfpm_chroot_user_absent.yml
  when:
    - ( users_phpfpm_version is defined ) and ( users_phpfpm_version != "" )
    - ( users_chroot is defined ) and ( users_chroot == True )
    - ( users_chroot_dir is defined ) and ( users_chroot_dir.stat.exists )
  tags:
    - users-update
    - users-chroot
    - phpfpm

- name: Absent users MariaDB account and databases absent
  include_tasks: mariadb_user_absent.yml
  when: ( users_mariadb is defined ) and ( users_mariadb == True )
  tags:
    - users-update
    - users-mariadb

- name: Chroot users mounts absent
  block:

    - name: Include the chroot users mounts absent tasks
      include_tasks: chroot_users_absent.yml
      when: ( user.value.users_state is defined and user.value.users_state == "absent" ) or ( "chroot" not in user.value.users_groups )
      tags:
        - users-chroot
        - users-update

  when: ( users_chroot_dir is defined ) and ( users_chroot_dir.stat.exists )

- name: Absent users home directories removed
  file:
    path: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}"
    state: absent
  tags:
    - users-update

- name: Users accounts absent
  user:
    name: "{{ user.key }}"
    state: absent
    remove: true
    force: true
  tags:
    - users-update

- name: User groups absent
  group:
    name: "{{ user.key }}"
    state: absent
  tags:
    - users-update
...
