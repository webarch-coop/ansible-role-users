---
# Use ~/.ssh/authorized_keys.d/authorized_keys_* files to assemble ~/.ssh/authorized_keys and leave a ~/.ssh/README.md to explain what happened
- name: ~/.ssh/authorized_keys.d directory present
  file:
    path: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.ssh/authorized_keys.d"
    state: directory
    owner: "{{ user.key }}"
    group: "{{ user.value.users_home_group | default(user.key) }}"
    mode: 0700
  tags:
    - users-ssh
    - users-update

- name: SSH public keys downloaded
  get_url:
    url: "{{ key_url }}"
    dest: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.ssh/authorized_keys.d/authorized_keys_{{ key_idex }}"
    owner: "{{ user.key }}"
    group: "{{ user.value.users_home_group | default(user.key) }}"
    mode: 0600
    force: true
  loop: "{{ user.value.users_ssh_public_keys }}"
  loop_control:
    loop_var: key_url
    index_var: key_idex
    label: "{{ key_url }}"
  tags:
    - users-ssh
    - users-update

- name: Assemble all the ~/authorized_keys_d/authorized_keys_* public keys to ~/.ssh/authorized_keys
  assemble:
    src: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.ssh/authorized_keys.d"
    dest: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.ssh/authorized_keys"
    remote_src: true
    validate: ssh-keygen -lf %s
  tags:
    - users-ssh
    - users-update

- name: SSH README.md in place
  template:
    src: templates/SSH_README.md.j2
    dest: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/.ssh/README.md"
    owner: "{{ user.key }}"
    group: "{{ user.value.users_home_group | default(user.key) }}"
    mode: 0600
  tags:
    - users-ssh
    - users-update
...
