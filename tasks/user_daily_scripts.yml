---
- name: "Check if {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/bin/cron_daily.sh exists"
  stat:
    path: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/bin/cron_daily.sh"
  register: users_bin_cron_daily
  tags:
    - users

- name: "Blank {{ user.value.users_home | default(users_basedir + '/' + user.key) }}/bin/cron_daily.sh in place"
  template:
    src: cron_daily.sh.j2
    dest: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/bin/cron_daily.sh"
    owner: "{{ user.key }}"
    group: "{{ user.value.users_group | default(user.key) }}"
    mode: "0750"
  when: not users_bin_cron_daily.stat.exists
  tags:
    - users

- name: "Daily scripts in place for {{ user.key }}"
  lineinfile:
    path: "{{ user.value.users_home | default(users_basedir + '/' + user.key) }}/bin/cron_daily.sh"
    line: "{{ command }}"
    state: present
    insertbefore: "^# END ANSIBLE SCRIPTS"
    firstmatch: true
    create: false
    owner: "{{ user.key }}"
    group: "{{ user.value.users_group | default(user.key) }}"
    mode: "0750"
  loop: "{{ vhost.value.users_daily_scripts }}"
  loop_control:
    loop_var: command
    label: "{{ command }}"
  tags:
    - users
...
