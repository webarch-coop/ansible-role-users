---
- name: Check /etc/debian_version
  shell: "cat /etc/debian_version | awk -F/ '{ print $1 }'"
  register: users_debian_version_check

- name: Set a fact for the Debian version
  set_fact:
    users_debian_version: "{{ users_debian_version_check.stdout }}"

- name: Packages present
  apt:
    pkg:
      - vim
    state: present
    update_cache: true

- name: Skel files and directories in place
  synchronize:
    src: files/skel.d/
    dest: /usr/local/etc/skel.d/
    perms: true
    recursive: true
    times: false

- name: Skel files chowned
  file:
    path: /usr/local/etc/skel.d
    state: directory
    owner: root
    group: root
    recurse: true

- block:

    - name: Absent users home directories removed
      file:
        path: "{{ item.value.users_home | default('/home/' + item.key) }}"
        state: absent
      loop: "{{ users | dict2items }}"

    - name: User accounts absent
      user:
        name: "{{ item.key }}"
        state: absent
        remove: true
      loop: "{{ users | dict2items }}"

    - name: User groups absent
      group:
        name: "{{ item.key }}"
        state: absent
      loop: "{{ users | dict2items }}"

  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User groups present
  include_tasks: groups.yml
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: users_groups_user
  when: ( users_groups_user.value.users_state is undefined or users_groups_user.value.users_state == "present" ) and users_groups_user.value.users_groups is defined

- block:

    - name: User group present
      group:
        name: "{{ item.key }}"
        state: present
      loop: "{{ users | dict2items }}"

    - name: User accounts present
      include_tasks: user.yml
      loop: "{{ users | dict2items }}"

    - name: Quotas set
      include_tasks: quota.yml
      loop: "{{ users | dict2items }}"
      when: quota_dir is defined and item.value.users_quota is defined and item.value.users_quota != ""

  when: item.value.users_state is undefined or item.value.users_state == "present"

- name: Check if php-fpm is installed
  shell: dpkg -s php-fpm | grep ^Status
  register: users_phpfpm_installed_check

- block:

    - name: Set the users_phpfpm_installed variable
      set_fact:
        users_phpfpm_installed: "true"

    - name: Check if php7.0-fpm is installed on stretch
      shell: dpkg -s php7.0-fpm | grep ^Status
      register: users_phpfpm_installed_check
      when: users_debian_version == "stretch"

    - name: Check if php7.3-fpm is installed on buster
      shell: dpkg -s php7.3-fpm | grep ^Status
      register: users_phpfpm_installed_check
      when: users_debian_version == "buster"

    - name: Fail if unsupported distro
      fail:
        msg: "Not runnng Debian stretch or buster so additonal PHP version check needed"
      when: '"stretch" not in users_phpfpm_version_check and "buster" not in users_phpfpm_version_check'

    - name: Include the PHP FPM tasks
      include_tasks: phpfpm.yml
      when: users_phpfpm_installed == "true" and users_phpfpm_version is defined

  when: users_phpfpm_installed_check is defined and "installed" in users_phpfpm_installed_check.stdout
