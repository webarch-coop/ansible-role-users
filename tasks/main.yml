---
- name: Packages present
  apt:
    pkg:
      - vim
    state: present
    update_cache: yes

- name: Skel files and directories in place
  synchronize:
    src: files/skel.d/
    dest: /usr/local/etc/skel.d/
    perms: yes
    recursive: yes
    times: no

- name: Skel files chowned
  file:
    path: /usr/local/etc/skel.d
    state: directory
    owner: root
    group: root
    recurse: yes

- name: Absent users home directories removed
  file:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}"
    state: absent
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User accounts absent
  user:
    name: "{{ item.key }}"
    state: absent
    remove: yes
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User groups absent
  group:
    name: "{{ item.key }}"
    state: absent
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User groups present
  include_tasks: groups.yml
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: users_groups_user
  #when: item.value.users_state is undefined or item.value.users_state == "present" and item.value.users_groups is defined
  when: users_groups_user.value.users_state is undefined or users_groups_user.value.users_state == "present" and users_groups_user.value.users_groups is defined

- name: User group present
  group:
    name: "{{ item.key }}"
    state: present
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is undefined or item.value.users_state == "present"

- name: User accounts present
  include_tasks: user.yml
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is undefined or item.value.users_state == "present"

- name: Quotas set
  include_tasks: quota.yml
  loop: "{{ users | dict2items }}"
  when: quota_dir is defined and item.value.users_quota is defined and item.value.users_quota != ""
