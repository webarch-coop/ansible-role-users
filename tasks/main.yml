---
- name: Check /etc/debian_version
  shell: "lsb_release -c | awk '{ print $2 }'"
  register: users_debian_version_check
  changed_when: false

- name: Set a fact for the Debian version
  set_fact:
    users_debian_version: "{{ users_debian_version_check.stdout }}"

- name: Load package information as facts
  package_facts:
    manager: apt
  tags:
    - apache

- name: Packages present
  apt:
    pkg:
      - vim
    state: present
    update_cache: true

- name: Skel profiles included
  include_tasks: "skel_{{ users_skeleton }}.yml"
  loop:
    - www
  loop_control:
    loop_var: users_skeleton

- name: "Get the md5sum of {{ quota_dir }}/quota_user.csv"
  command: "md5sum {{ quota_dir }}/quota_user.csv"
  register: users_repquota_md5sum_before
  changed_when: false

- name: "Users quotas written to {{ quota_dir }}/quota_user.csv and md5sum printed"
  shell: "repquota {{ quota_dir }}  --output=csv > {{ quota_dir }}/quota_user.csv ; chmod 700 {{ quota_dir }}/quota_user.csv ; md5sum {{ quota_dir }}/quota_user.csv"
  register: users_repquota_md5sum_after
  when: quota_dir is defined
  changed_when: users_repquota_md5sum_before.stdout != users_repquota_md5sum_after.stdout

- name: Users quotas fetched
  fetch:
    src: "{{ quota_dir }}/quota_user.csv"
    dest: /tmp/
  when: quota_dir is defined

- block:

    - name: Absent users home directories removed
      file:
        path: "{{ item.value.users_home | default('/home/' + item.key) }}"
        state: absent
      loop: "{{ users | dict2items }}"

    - name: User accounts absent
      user:
        name: "{{ item.key }}"
        state: absent
        remove: true
      loop: "{{ users | dict2items }}"

    - name: User groups absent
      group:
        name: "{{ item.key }}"
        state: absent
      loop: "{{ users | dict2items }}"

  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User groups present
  include_tasks: groups.yml
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: users_groups_user
  when: ( users_groups_user.value.users_state is undefined or users_groups_user.value.users_state == "present" ) and users_groups_user.value.users_groups is defined

- block:

    - name: User group present
      group:
        name: "{{ item.key }}"
        state: present
      loop: "{{ users | dict2items }}"

    - name: User accounts present
      include_tasks: user.yml
      loop: "{{ users | dict2items }}"

    - name: Quotas set
      include_tasks: quota.yml
      loop: "{{ users | dict2items }}"
      when: quota_dir is defined and item.value.users_quota is defined and item.value.users_quota != ""

  when: item.value.users_state is undefined or item.value.users_state == "present"

- name: "Updated users quotas written to {{ quota_dir }}/quota_user.csv and md5sum printed"
  shell: "repquota {{ quota_dir }}  --output=csv > {{ quota_dir }}/quota_user.csv ; chmod 700 {{ quota_dir }}/quota_user.csv ; md5sum {{ quota_dir }}/quota_user.csv"
  register: users_repquota_md5sum_after
  when: quota_dir is defined
  changed_when: users_repquota_md5sum_before.stdout != users_repquota_md5sum_after.stdout

- name: Updated users quotas fetched
  fetch:
    src: "{{ quota_dir }}/quota_user.csv"
    dest: /tmp/
  when: quota_dir is defined and users_repquota_md5sum_after.changed

- name: Email address in .forward
  template:
    src: templates/forward.j2
    dest: "{{ item.value.users_home | default('/home/' + item.key) }}/.forward"
    owner: "{{ item.key }}"
    group: "{{ item.key }}"
    mode: 0644
  loop: "{{ users | dict2items }}"
  when: item.value.users_email is defined and item.value.users_email != ""

- name: Email address absent so no .forward
  file:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}/.forward"
    state: absent
  loop: "{{ users | dict2items }}"
  when: item.value.users_email is not defined or item.value.users_email == ""

- name: Check if php-fpm is installed on stretch
  shell: dpkg -s php7.0-fpm | grep ^Status | awk '{ print $4 }'
  register: users_phpfpm_status
  when: users_debian_version == "stretch"
  changed_when: false

- name: Check if php-fpm is installed on buster
  shell: dpkg -s php7.3-fpm | grep ^Status | awk '{ print $4 }'
  register: users_phpfpm_status
  when: users_debian_version == "buster"
  changed_when: false

- name: Check if a chroot exists
  stat:
    path: "{{ chroot_dir | default('/chroot') }}"
  register: users_chroot_dir

- name: Include the chroot user tasks
  include_tasks: chroot_user.yml
  loop: "{{ users | dict2items }}"
  when: users_chroot_dir.stat.exists

- name: Include the PHP FPM chroot tasks
  include_tasks: phpfpm_chroot.yml
  when: users_phpfpm_status.stdout == "installed" and users_chroot_dir.stat.exists

- name: Include Apache config
  include_tasks: apache.yml
  loop: "{{ users | dict2items }}"
  when: ( "apache2" in ansible_facts.packages ) and item.value.users_apache_virtual_hosts is defined
  tags:
    - apache

- name: Apache configtest
  command: apachectl configtest
  register: users_apachectl_configtest
  changed_when: '"Syntax OK" not in users_apachectl_configtest.stderr'
  tags:
    - apache
