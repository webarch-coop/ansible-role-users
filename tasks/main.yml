---
- name: Packages present 
  apt:
    pkg:
      - bc
      - vim
    state: present
    update_cache: yes

#- name: Add group accounts
#  group:
#    name:
#    state:
#    system:
#  loop: "{{ users | dict2items }}"

- name: User accounts absent
  user:
    name: "{{ item.key }}"
    state: absent
    remove: yes
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is defined and item.value.users_state == "absent"

- name: User accounts present 
  include_tasks: user.yml
  loop: "{{ users | dict2items }}"
  when: item.value.users_state is undefined or item.value.users_state == "present"

- name: Quotas set
  include_tasks: quota.yml
  loop: "{{ users | dict2items }}"
  when: quota_dir is defined and item.value.users_quota is defined and item.value.users_quota != ""

- name: Skel files and directories in place
  synchronize:
    src: "files/skel.d/{{ item.value.users_skel }}"
    dest: "{{ item.value.users_home | default('/home/' + item.key) }}"
    owner: "{{ item.key }}"
    group: "{{ item.key }}"
    perms: yes
    recursive: yes
    times: no 
  loop: "{{ users | dict2items }}"
  when: item.value.users_skel is defined
