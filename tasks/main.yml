---
- debug:
    msg: "name: {{ item.name }} groups: {{ item.groups }} home: {{ item.home }} system: {{ item.system }} editor: {{ item.editor }}"
    verbosity: 1
  loop: "{{ user_accounts }}"

# item.home would ideally be populated with /home/item.name if not set
- name: Add user accounts
  user:
    name: "{{ item.name }}"
    groups: "{{ item.groups }}"
    home: "{{ item.home }}"
    shell: "{{ item.shell }}"
    system: "{{ item.system }}"
  loop: "{{ user_accounts }}"

- name: SSH private directories present
  file:
    path: "{{ item.home }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0700 
  loop: "{{ user_accounts }}"
  when: item.ssh_public_keys is defined and item.ssh_public_keys != ""

- name: SSH public keys present
  get_url:
    url: "{{ item.ssh_public_keys }}"    
    dest: "{{ item.home }}/.ssh/authorized_keys"    
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0600 
  loop: "{{ user_accounts }}"
  when: item.ssh_public_keys is defined and item.ssh_public_keys != ""

- name: Set default editor
  copy:
    src: "files/{{ item.editor }}/selected_editor"
    dest: "{{ item.home }}/.selected_editor"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0644 
  loop: "{{ user_accounts }}"
  when: item.editor is defined and item.editor != ""

# Ideally this would get the unique list of editors needed on this server...
- name: Editors installed
  apt:
    pkg: 
      - vim
    state: present
    update_cache: yes

- name: .vimrc in place
  copy:
    src: "files/vim/vimrc"
    dest: "{{ item.home }}/.vimrc"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0644 
  loop: "{{ user_accounts }}"
  when: item.editor is defined and item.editor == 'vim' 

- name: vim set to be default editor
  lineinfile:
    path: "{{ item.home }}/.bashrc"
    line: 'export EDITOR="vim"'
    state: present
  loop: "{{ user_accounts }}"
  when: item.editor is defined and item.editor == 'vim'


