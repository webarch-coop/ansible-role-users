---
- debug:
    msg: "name: {{ item.name }} groups: {{ item.groups }} home: {{ item.home }} system: {{ item.system }} editor: {{ item.editor }}"
    verbosity: 1
  loop: "{{ user_accounts }}"

# item.groups would ideally be set to "" if not set
# item.home would ideally be populated with /home/item.name if not set
# item.shell would ideally be set to /bin/bash if not set
# item.system would ideally be set to "no" if not set
# https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#defaulting-undefined-variables
# https://stackoverflow.com/a/41727473
- name: Add user accounts
  user:
    name: "{{ item.key }}"
    groups: "{{ item.value.groups | default() }}"
    home: "{{ item.value.home | default(omit) }}"
    shell: "{{ item.value.shell | default('/bin/bash', true) }}"
    system: "{{ item.value.system | default(omit) }}"
  loop: "{{ lookup('dict', users) }}"

#- name: SSH private directories present
#  file:
#    path: "{{ item.home }}/.ssh"
#    state: directory
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0700 
#  loop: "{{ user_accounts }}"
#  when: item.ssh_public_keys is defined and item.ssh_public_keys != ""
#
#- name: SSH public keys present
#  get_url:
#    url: "{{ item.ssh_public_keys }}"    
#    dest: "{{ item.home }}/.ssh/authorized_keys"    
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0600 
#  loop: "{{ user_accounts }}"
#  when: item.ssh_public_keys is defined and item.ssh_public_keys != ""
#
#- name: Set default editor
#  copy:
#    src: "files/{{ item.editor }}/selected_editor"
#    dest: "{{ item.home }}/.selected_editor"
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0644 
#  loop: "{{ user_accounts }}"
#  when: item.editor is defined and item.editor != ""
#
## Ideally this would get the unique list of editors needed on this server...
#- name: Editors installed
#  apt:
#    pkg: 
#      - vim
#    state: present
#    update_cache: yes
#
#- name: .vimrc in place
#  copy:
#    src: "files/vim/vimrc"
#    dest: "{{ item.home }}/.vimrc"
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0644 
#  loop: "{{ user_accounts }}"
#  when: item.editor is defined and item.editor == 'vim' 
#
#- name: vim set to be default editor
#  lineinfile:
#    path: "{{ item.home }}/.bashrc"
#    line: 'export EDITOR="vim"'
#    state: present
#  loop: "{{ user_accounts }}"
#  when: item.editor is defined and item.editor == 'vim'
#
#
