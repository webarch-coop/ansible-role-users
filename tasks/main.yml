---
# https://github.com/ansible/ansible/issues/10164#issuecomment-73470662
- debug:
    msg: "name: {{ item.key }} | groups: {{ item.value.groups | default([]) | join(',') or omit }} | home: {{ item.value.home | default(['/home/' + item.key]) }} | system: {{ item.value.system | default('no', false) }} | editor: {{ item.value.editor | default('vim', true) }}"
    verbosity: 1
  loop: "{{ users | dict2items }}"

- name: Add user accounts
  user:
    name: "{{ item.key }}"
    groups: "{{ item.value.groups | default([]) | join(',') or omit }}"
    home: "{{ item.value.home | default(['/home/' + item.key]) }}"
    shell: "{{ item.value.shell | default('/bin/bash', true) }}"
    system: "{{ item.value.system | default('no', false) }}"
  loop: "{{ users | dict2items }}"

- name: SSH private directories present
  file:
    path: "{{ [ item.value.home + '/.ssh' ] | default(['/home/' + item.key + '/.ssh']) }}"
    state: directory
    owner: "{{ item.key }}"
    group: "{{ item.key }}"
    mode: 0700 
  loop: "{{ users | dict2items }}"
  when: item.value.ssh_public_keys is defined and item.value.ssh_public_keys != "" 

#- name: SSH public keys present
#  get_url:
#    url: "{{ item.ssh_public_keys }}"    
#    dest: "{{ item.home }}/.ssh/authorized_keys"    
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0600 
#  loop: "{{ users | dict2items }}"
#  when: item.ssh_public_keys is defined and item.ssh_public_keys != ""
#
#- name: Set default editor
#  copy:
#    src: "files/{{ item.editor }}/selected_editor"
#    dest: "{{ item.home }}/.selected_editor"
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0644 
#  loop: "{{ users | dict2items }}"
#  when: item.editor is defined and item.editor != ""
#
## Ideally this would get the unique list of editors needed on this server...
#- name: Editors installed
#  apt:
#    pkg: 
#      - vim
#    state: present
#    update_cache: yes
#
#- name: .vimrc in place
#  copy:
#    src: "files/vim/vimrc"
#    dest: "{{ item.home }}/.vimrc"
#    owner: "{{ item.name }}"
#    group: "{{ item.name }}"
#    mode: 0644 
#  loop: "{{ users | dict2items }}"
#  when: item.editor is defined and item.editor == 'vim' 
#
#- name: vim set to be default editor
#  lineinfile:
#    path: "{{ item.home }}/.bashrc"
#    line: 'export EDITOR="vim"'
#    state: present
#  loop: "{{ users | dict2items }}"
#  when: item.editor is defined and item.editor == 'vim'
#
#
