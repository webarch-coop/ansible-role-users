---
- name: "Stat {{ item.value.users_home | default('/home/' + item.key) }}/.notify_passwd file"
  stat:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}/.notify_passwd"
  register: users_notify_passwd_file
  tags:
    - users-update

- block:

    - name: "Random passwd for {{ item.key }} generated"
      command: pwgen -n 20 1
      no_log: true
      register: users_passwd
      tags:
        - users-update

    - name: "SHA 512 hash of passwd generated"
      command: "mkpasswd --method=sha-512 {{ users_passwd.stdout }}"
      register: users_passwd_hash
      tags:
        - users-update

    - name: "Password set for {{ item.key }}"
      user:
        name: "{{ item.key }}"
        password: "{{ users_passwd_hash.stdout }}"
      tags:
        - users-update

    - name: "Password notification email sent to {{ item.value.users_email }}"
      mail:
        from: "{{ users_notify_from | default('Webarchitects') }} <root@{{ inventory_hostname }}>"
        to: "{{ item.value.users_name | default(item.key) }} <{{ item.value.users_email }}>"
        subject: "[{{ users_notify_subject_tag | default('webarchitects') }}] SFTP / SSH Password for {{ item.key }} on {{ inventory_hostname }}"
        headers: "{{ users_notify_headers }}"
        charset: us-ascii
        body: "{{ lookup('template', 'templates/notify_passwd.j2') }}"
        host: localhost
        port: 25
        secure: never
      when: item.value.users_email is defined and item.value.users_email != ""
      tags:
        - users-update

    - name: "Notification date recorded in {{ item.value.users_home | default('/home/' + item.key) }}/.notify_passwd file"
      lineinfile:
        path: "{{ item.value.users_home | default('/home/' + item.key) }}/.notify_passwd"
        line: "{{ lookup('pipe', 'date +%Y-%m-%d-%H-%M-%S')}} : {{ item.value.users_name | default(item.key) }} <{{ item.value.users_email }}>"
        create: true
        state: present
        insertafter: EOF
        owner: root
        group: "{{ item.value.users_group }}"
        mode: 0640
      tags:
        - users-update

  when: users_notify_passwd_file.stat.exists == False
