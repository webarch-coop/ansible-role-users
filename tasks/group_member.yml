---
# This is included from group_members.yml

- name: "Check that the {{ member }} group exists and create it if it doesn't"
  block:

    - name: "Check that the group {{ member }} exists"
      command: "getent group {{ member }}"
      register: users_group_check

  rescue:

    - name: "Create {{ member }} group"
      group:
        name: "{{ member }}"
        state: present

  tags:
    - users

- name: "Users that have membership of {{ user.value.users_group | default(user.key) }} group"
  command: "usermod -a -G {{ user.value.users_group | default(user.key) }} {{ member }}"
  tags:
    - users
...
