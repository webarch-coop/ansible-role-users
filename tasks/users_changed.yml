---
- name: Directories for users state files present
  file:
    path: "{{ users_state_dir }}/{{ dir }}"
    state: directory
  loop:
    - current
    - previous
    - proposed
  loop_control:
    loop_var: dir

- name: Proposed users state files present
  template:
    src: user_state.yml.j2
    dest: "{{ users_state_dir }}/proposed/{{ user.key }}.yml"
  check_mode: false
  register: users_state_file
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: user
    label: "{{ user.key }}"

# The following will list the user state files that have changed
# however if the tasks were not full completed then just using 
# this would result in changes not being applied, so a check of
# the proposed vs the current state files is needed.
#
# - name: Debug
#   debug:
#     msg: "User changed: {{ result.user.key }}"
#   when: result.changed
#   loop: "{{ users_state_file.results }}"
#   loop_control:
#     loop_var: result
#     label: "{{ result }}"
# 
# - name: Users that need updating
#   set_fact:
#     users_check_state: "{{ users_check_state }} + [ '{{ result.user.key }}' ]"
#   when: result.changed
#   loop: "{{ users_state_file.results }}"
#   loop_control:
#     loop_var: result
#     label: "{{ result }}"

- name: Set an empty users_update arrays
  set_fact:
    users_update: []

- name: Check users current state files
  include_tasks: user_state.yml
  loop: "{{ users | dict2items }}"
  loop_control:
    loop_var: user

- name: Print the users to update
  debug:
    msg: "User to update: {{ users_update }}"
    verbosity: 2
...
