---
# One cert per VirtualHost
- name: Let's Encrypt cert role included
  include_role:
    name: acmesh
    tasks_from: letsencrypt
  vars:
    common_name: "{{ vhost.value.users_apache_server_name }}"
    subject_alt_names: "{{ vhost.value.users_apache_server_aliases }}"
  loop: "{{ item.value.users_apache_virtual_hosts | dict2items }}"
  loop_control:
    loop_var: vhost
  when: users_cert == "vhost"
  tags:
    - apache

# One cert per user
- block:

    - name: Set fact for commonName
      set_fact:
        common_name: "{{ item.key }}.{{ inventory_hostname }}"

    - name: Set fact subjectAltNames
      set_fact:
        sans: "{{ vhost.value.users_apache_server_name }} + [ '{{ vhost.value.users_apache_server_aliases }}' ]"
      loop: "{{ item.value.users_apache_virtual_hosts | dict2items }}"
      register: subject_alt_names
      loop_control:
        loop_var: vhost
      tags:
        - apache

    - debug:
        msg: "subject_alt_names is set to: {{ subject_alt_names }}"

    - debug:
        msg: "sans is set to: {{ sans }}"

    - debug:
        msg: "{{ subject_alt_names.results | map(attribute='ansible_facts.sans') | list }}"

    - fail:
        msg: debug stop

    - name: Let's Encrypt cert role included
      include_role:
        name: acmesh
        tasks_from: letsencrypt
      tags:
        - apache

  when: users_cert == 'user'

- name: "Apache {{ item.key }} sites-available file present"
  template:
    src: templates/apache.conf.j2
    dest: "/etc/apache2/sites-available/{{ item.key }}.conf"
  tags:
    - apache

- name: "Apache {{ item.key }}/sites directory present"
  file:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}/sites"
    state: directory
    owner: "{{ item.key }}"
    # group: "{{ apache_user | default('www-data') }}"
    group: "{{ item.value.users_group | default(item.key) }}"
    mode: 0750
  tags:
    - apache

- name: "Apache DocumentRoot present"
  file:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}/sites/{{ vhost }}"
    state: directory
    owner: "{{ item.key }}"
    # group: "{{ apache_user | default('www-data') }}"
    group: "{{ item.value.users_group | default(item.key) }}"
    mode: 0750
  loop: "{{ item.value.users_apache_virtual_hosts.keys() | list }}"
  loop_control:
    loop_var: vhost
  tags:
    - apache

- name: "Apache log directory {{ item.value.users_home | default('/home/' + item.key) }}/logs present"
  file:
    path: "{{ item.value.users_home | default('/home/' + item.key) }}/logs"
    state: directory
    owner: root
    group: "{{ item.key }}"
    mode: 0750
  tags:
    - apache

- name: "Apache {{ item.key }} sites-enabled symlink present"
  command: "a2ensite {{ item.key }}"
  register: users_a2ensite
  changed_when: '"already enabled" not in users_a2ensite.stdout'
  tags:
    - apache

- name: WP install
  include_tasks: wordpress.yml
  loop: "{{ item.value.users_apache_virtual_hosts | dict2items }}"
  when: ( vhost.value.users_cms is defined ) and ( vhost.value.users_cms == "wordpress" )
  loop_control:
    loop_var: vhost
  tags:
    - apache
