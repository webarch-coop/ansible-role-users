---
- name: Check which shells are present
  shell: cat /etc/shells | grep -v ^#
  check_mode: false
  changed_when: false
  register: users_shells_check

- name: Array set for shells
  set_fact:
    users_shells: "{{ users_shells_check.stdout_lines | list }}"

- name: Print available shells
  debug:
    msg: "Available shells: {{ users_shells }}"
    verbosity: 2

- name: Get all groups
  getent:
    database: group
    split: ':'

- debug:
    var: getent_group
    verbosity: 2

- name: Get all users
  getent:
    database: passwd
    split: ':'

- debug:
    var: getent_passwd
    verbosity: 2

- name: Set a fact for the Debian version
  set_fact:
    users_debian_version: "{{ ansible_distribution_release }}"
  tags:
    - apache
    - letsencrypt
    - logrotate
    - phpfpm
    - users-update
    - users-cron
    - users-mariadb
    - users-scripts
    - users-quota
    - users-fstab
    - wordpress
    - matomo
    - phpmyadmin

- name: Load package information as facts
  package_facts:
    manager: apt
  tags:
    - apache
    - letsencrypt
    - logrotate
    - phpfpm
    - users-update
    - users-cron
    - users-mariadb
    - users-scripts
    - users-quota
    - users-fstab
    - wordpress
    - matomo
    - phpmyadmin

- name: Fail if ansible_facts.packages is not defined or empty
  fail:
    msg: The package_facts array is empty, this could be a result of the Ansible 2.8.x bug https://github.com/ansible/ansible/issues/56921
  when: ( ansible_facts.packages is not defined ) or ( ansible_facts.packages == [] )
  tags:
    - apache
    - letsencrypt
    - logrotate
    - phpfpm
    - users-update
    - users-cron
    - users-mariadb
    - users-scripts
    - users-quota
    - users-fstab
    - wordpress
    - matomo
    - phpmyadmin

- name: PHP-FPM chroot tasks
  include_tasks: phpfpm_chroot.yml
  tags:
    - phpfpm
    - logrotate
    - users-chroot

- name: PHP FPM checks
  block:

    - name: Check that php-fpm is installed
      assert:
        that:
          - '"php-fpm" in ansible_facts.packages'
      tags:
        - logrotate
        - phpfpm
        - users-update

    - name: Run phpquery -V
      command: phpquery -V
      register: users_phpquery
      check_mode: false
      changed_when: false
      tags:
        - logrotate
        - phpfpm
        - users-update

    - name: Set a fact for the PHP-FPM version
      set_fact:
        users_phpfpm_version: "{{ users_phpquery.stdout | trim }}"
      when: ( users_phpquery is defined ) and ( users_phpquery.stdout != "" )
      tags:
        - logrotate
        - phpfpm
        - users-update

  when: ( users_phpfpm is defined ) and ( users_phpfpm == True )

- name: Check if a chroot exists
  stat:
    path: "{{ chroot_dir | default('/chroot') }}"
  register: users_chroot_dir
  when: ( users_chroot is defined ) and ( users_chroot == True )
  tags:
    - logrotate
    - phpfpm
    - users-update
    - users-chroot
    - users-cron
    - users-fstab

- name: Quota tasks
  block:

    - name: "Touch {{ quota_dir }}/quota_user.csv"
      file:
        path: "{{ quota_dir }}/quota_user.csv"
        state: touch
        access_time: preserve
      check_mode: false
      tags:
        - users-update
        - users-quota

    - name: "Get the md5sum of {{ quota_dir }}/quota_user.csv"
      command: "md5sum {{ quota_dir }}/quota_user.csv"
      register: users_repquota_md5sum_before
      check_mode: false
      changed_when: false
      when: quota_dir is defined
      tags:
        - users-update
        - users-quota

    - name: "Users quotas written to {{ quota_dir }}/quota_user.csv and md5sum printed"
      shell: "repquota {{ quota_dir }}  --output=csv > {{ quota_dir }}/quota_user.csv ; chmod 600 {{ quota_dir }}/quota_user.csv ; md5sum {{ quota_dir }}/quota_user.csv"
      register: users_repquota_md5sum_after
      check_mode: false
      changed_when: users_repquota_md5sum_before.stdout != users_repquota_md5sum_after.stdout
      tags:
        - users-update
        - users-quota

    - name: Users quotas fetched
      fetch:
        src: "{{ quota_dir }}/quota_user.csv"
        dest: /tmp/
      check_mode: false
      tags:
        - users-update
        - users-quota

  when: ( users_quotaon is defined ) and ( users_quotaon == True ) and ( quota_dir is defined )

- name: Include Apache tasks
  include_tasks: apache.yml
  when:
    - '"apache2" in ansible_facts.packages'
    - ( users_apache is defined ) and ( users_apache == True )
...
